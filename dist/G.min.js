/**
 * G 0.2, 2014-02-22
 * A fast, powerful and extendable HTML5 game framework
 *
 * Copyright (c) 2014 Gurudayal Khalsa, gurudayalkhalsa@gmail.com
 * Licensed under MIT
 */
!function(a,b,c){"function"==typeof define&&define.amd?define(function(){return c.call(b)}):"object"==typeof module&&"object"==typeof module.exports?module.exports=c.call(b):b[a]=c(b)}("G",this,function(){var a={};(function(){var a=!1,b=/xyz/.test(function(){})?/\b_super\b/:/.*/;this.Class=function(a){for(var b in a)"initialize"!==b&&(this[b]=a[b]);a&&a.initialize&&a.initialize.apply(this)},this.Class.extend=function(c){function Class(){!a&&this.initialize&&this.initialize.apply(this,arguments)}var d=this.prototype;a=!0;var e=new this;a=!1;for(var f in c)e[f]="function"==typeof c[f]&&"function"==typeof d[f]&&b.test(c[f])?function(a,b){return function(){var c=this._super;this._super=d[a];var e=b.apply(this,arguments);return this._super=c,e}}(f,c[f]):c[f];return Class.prototype=e,Class.prototype.constructor=Class,Class.extend=arguments.callee,Class}}).call(a),this.Emit=a.Emit=function(){var a=function(){};return a.prototype={on:function(a,b){return this._events=this._events||{},this._events[a]=this._events[a]||[],this._events[a].push(b),{context:this,event:a,type:"on",callback:b,makeOne:function(){this.off();var a=this.context.one(this.event,this.callback);for(var b in a)this[b]=a[b]},off:function(){this.context.off(this.event,this.callback)}}},one:function(a,b){return this._events=this._events||{},this._events[a]=this._events[a]||[],this._events[a].push(["one",b]),{context:this,event:a,type:"off",callback:b,makeOn:function(){this.off();var a=this.context.on(this.event,this.callback);for(var b in a)this[b]=a[b]},off:function(){this.context.off(this.event,this.callback)}}},off:function(a,b){if(this._events=this._events||{},a in this._events!=!1&&!(this._events[a].splice(this._events[a].indexOf(b),1).length>0)){for(var c=0;c<this._events[a].length;c++)"object"==typeof this._events[a][c]&&"one"===this._events[a][0]&&this._events[a][c][1]===b&&this._events[a].splice(this._events[a][c],1);return this}},trigger:function(a){if(this._events=this._events||{},this._events[a]){for(var b=[],c=0;c<this._events[a].length;c++){var d;if("one"===this._events[a][c][0]){var e=this._events[a][c][1];this._events[a].splice(c,1),d=e.apply(this,arguments[1]||void 0)}else d=this._events[a][c].apply(this,arguments[1]||void 0);b.push(d)}return b}}},a.mixin=function(b){for(var c=["on","one","off","trigger"],d=0;d<c.length;d++)"function"==typeof b?b.prototype[c[d]]=a.prototype[c[d]]:b[c[d]]=a.prototype[c[d]]},a}(a);var b=a.Event=function(){function b(a){function b(a,c,d,e,f,g){function h(){f.apply(this,arguments),e.removeEventListener(d,h)}if(Array.isArray(d)||"object"!=typeof d&&("string"!=typeof d||1!==d.split(",").length)){"string"==typeof d&&(d=d.split(","));for(var i=0;i<d.length;i++)b(a,c,d[i],e,f,g)}else"one"===c?e[a](d,h,g):e[a](d,f,g)}for(var c=arguments.length>2&&"object"==typeof arguments[1]?arguments[1]:window,d=2===arguments.length?arguments[1]:"function"==typeof arguments[1]?arguments[1]:"function"==typeof arguments[2]?arguments[2]:arguments[3],e=!1,f=0;f<arguments.length;f++)arguments[f]===!0&&(e=!0);if("undefined"==typeof arguments[0])return!1;if("undefined"==typeof d)return console.trace("No callback specified. Not listening for event."),!1;if("undefined"==typeof c.addEventListener)return console.warn("Invalid DOM object. Not listening for event.",arguments[1]),!1;var g=this.events||g;if(Array.isArray(a)||"string"==typeof a&&a.split(",").length>1||a in g){"string"==typeof a&&(a=a.split(","));for(var f=0;f<a.length;f++)if(a[f]in g)for(var h=g[a[f]],i=0;i<h.length;i++)0===i?a.splice(f,1,h[i]):a.splice(f,0,h[i])}return{run:b,el:c,callback:d,event:a,useCapture:e}}{var c=this,d=c;c.events={move:["mousemove","touchmove"],down:["mousedown","touchstart"],up:["mouseup","touchend"]}}c.on=function(){var a=b.apply(this,arguments);return a?(a.run("addEventListener","on",a.event,a.el,a.callback,a.useCapture),{off:function(){c.off(a.event,a.el,a.callback)}}):!1},c.one=function(){var a=b.apply(this,arguments);return a?(a.run("addEventListener","one",a.event,a.el,a.callback,a.useCapture),{off:function(){c.off(a.event,a.el,a.callback)}}):!1},c.off=function(){var a=b.apply(this,arguments);return a?(a.run("removeEventListener","off",a.event,a.el,a.callback),c):!1},c.key=function(){function b(a){for(var c=[],d=0,e=a.length;e>d;d++){var f=Object.prototype.toString.call(a[d]).split(" ").pop().split("]").shift().toLowerCase();f&&(c=c.concat(/^(array|collection|arguments|object)$/.test(f)?b(a[d]):a[d]))}return c}function c(a){var b=[];for(var c in a)void 0!==a[c]&&b.push(a[c]);return b}function d(a,c){if(Array.isArray(c)){for(var e=0;e<c.length;e++)if(d(a,c[e]))return!0;return!1}return Array.isArray(a)?-1!==b(a).indexOf(c):a[c]?!0:!1}function e(a,b,e){function f(a,m){function n(a){var b=[];return Array.isArray(i[a])?_.each(i[a],function(a){b.push(a)}):"string"==typeof i[a]&&b.push(i[a]),0!==b.length&&(a=b),a}if(!m&&i[a]&&(a=Array.isArray(a)?a.map(function(a){return n(a)}):n(a),Array.isArray(a))){for(var o=0;o<a.length;o++)if(Array.isArray(a[o])){for(var p=0;p<a[o].length;p++)if(f(a[o][p],!0))return!0}else if(f(a[o],!0))return!0;return!1}if(e&&(e.keys=c(Object.keys(h[b]).map(function(a){for(var b in j)if(-1!==j[b].indexOf(a))return void 0;return a})).join("+")),e&&(e.metaKey||e.ctrlKey||e.shiftKey)&&!d(a,[l[k.metaKey],l[k.ctrlKey],l[k.shiftKey]]))return!1;if(e&&e.metaKey&&d(a,l[k.metaKey])&&!d(a,g.toString(e.keyCode)))return!1;if(Array.isArray(a)&&1===a.length)return f(a[0]);if(!("string"!=typeof a||e&&g.toString(e.keyCode)!==a))return a in h[b];if("string"==typeof a&&g.toString(e.keyCode)!==a)return!1;if(Array.isArray(a))for(var o=0;o<a.length;o++)if(!(a[o]in h[b]))return!1;return!0}if(!a){if(e){var m=[],n=[l[k.metaKey],l[k.ctrlKey],l[k.shiftKey],l[18]];if(d(h[b],n)||"meta"in h[b]){for(var o in n)d(h[b],n[o])&&!d(m,n[o])&&m.push(n[o][0]);for(var o in h[b])d([n,"meta"],o)||m.push(o)}else for(var o in h[b])m.push(o);e.keys=m.join("+")}return!0}for(var m="string"==typeof a?a.split(g.separator):a,o=0;o<m.length;o++)m[o].split("+").length>1&&(m[o]=m[o].split("+"));if(m.length>1){for(var o=0;o<m.length;o++)if(f(m[o]))return!0;return!1}return f(m[0])}var f,g={};g.setRoot=function(a){if("function"!=typeof a.addEventListener&&console.warn("Invalid root, setting to window."),f="function"==typeof a.addEventListener?a:"function"==typeof window.addEventListener?window:"nosupport","undefined"==typeof f)throw new Error("Key must be run in a browser");if("nosupport"===f)throw new Error("Key must be run in a browser with support for addEventListener. IE8 and below, and similar old browsers are not supported.");return g},g.setRoot(window),g.separator=",";var h=g.state={up:{},down:{}},i=g.map={},j={shift:["⇧"],alt:["option","⌥"],ctrl:-1!==navigator.userAgent.indexOf("Macintosh")?["control","⌃"]:["control","⌃","meta"],cmd:-1!==navigator.userAgent.indexOf("Macintosh")?["command","⌘","meta"]:["command","⌘"]},k={shiftKey:16,altKey:18,ctrlKey:17,metaKey:-1!==navigator.userAgent.indexOf("Macintosh")?91:18},l={16:["shift","⇧"],18:["alt","option","⌥"],17:["ctrl","control","⌃"],91:["cmd","command","⌘"],8:"backspace",9:"tab",12:"clear",13:"enter",13:"return",27:"escape",32:"space",37:"left",38:"up",39:"right",40:"down",46:"delete",36:"home",35:"end",33:"pageup",34:"pagedown",188:",",190:".",191:"/",192:"`",189:"-",187:"=",186:";",222:"'",219:"[",221:"]",220:"\\"};return function(){var b={down:function(a){var b=g.toString(a.keyCode);Array.isArray(b)||(b=[b]);for(var c=0;c<b.length;c++)h.down[b[c]]=!0,h.up={};a.metaKey&&(h.down.meta=!0)},up:function(b){var c=g.toString(b.keyCode);Array.isArray(c)||(c=[c]);for(var d=0;d<c.length;d++)h.up[c[d]]=!0,delete h.down[c[d]];b.metaKey||delete h.down.meta,("cmd"===c[0]||"ctrl"===c[0])&&(h.down={}),setTimeout(function(){h.up={}},a.stage?a.stage.deltaTime||1e3/60:1e3/60)}};return f.removeEventListener("keydown",b.down),f.removeEventListener("keyup",b.up),f.addEventListener("keydown",b.down,!0),f.addEventListener("keyup",b.up,!0),g}(),g.toString=function(a){var b=String.fromCharCode(a);if(b&&!l[a])var c=b.toLowerCase();else var c=l[a];return c},g.isDown=function(a,b){return e(a,"down",b)},g.isUp=function(a,b){return e(a,"up",b)},g.on=function(a,b){function c(a){var c="keydown"===d?g.isDown(e,a):g.isUp(e,a);c&&b(a)}if(-1===a.indexOf("keydown")||-1===a.indexOf("keyup")){var d=1===a.split(":").length?"keyup"===a?"keyup":"keydown":a.split(":")[0],e=a.split(":").length>1?a.split(":")[1]:"keydown"===a||"keyup"===a?!1:a;return f.addEventListener(d,c),{off:function(){g.off(d,c)}}}var h="keyup"+a.split(g.separator+"keyup")[1],i=a.split(g.separator+"keyup")[0];"string"==typeof h&&g.on(h,b),"string"==typeof i&&g.on(i,b)},g.one=function(a,b){function c(a){var h="keydown"===d?g.isDown(e,a):g.isUp(e,a);h&&(b(a),f.removeEventListener(d,c))}if(-1===a.indexOf("keydown")||-1===a.indexOf("keyup")){var d=1===a.split(":").length?"keydown":a.split(":")[0],e=a.split(":").length>1?a.split(":")[1]:"keydown"===a||"keyup"===a?!1:a;return f.addEventListener(d,c),{off:function(){g.off(d,c)}}}var h="keyup"+a.split(g.separator+"keyup")[1],i=a.split(g.separator+"keyup")[0];"string"==typeof h&&g.on(h,b),"string"==typeof i&&g.on(i,b)},g.off=function(a,b){f.removeEventListener(a,b)},g}(),c.mouse=function(){function a(a){try{var b=a.getBoundingClientRect()}catch(c){throw new Error("Invalid DOM Element")}var d=b.left,e=b.top;return[d,e]}function b(a){return Array.prototype.splice.call(a,1,0,c),a}var c,e={};e.setRoot=function(a){if(("undefined"==typeof a||"function"!=typeof a.addEventListener)&&console.warn("Invalid root, setting to window."),c="undefined"!=typeof a&&"function"==typeof a.addEventListener?a:"function"==typeof window.addEventListener?window:"nosupport","undefined"==typeof c)throw new Error("Mouse must be run in a browser");if("nosupport"===c)throw new Error("Mouse must be run in a browser with support for addEventListener. IE8 and below, and similar old browsers are not supported.");return e},e.setRoot(window),e.root=c,e.state={moving:!1,down:!1,up:!0,left:!1,right:!1,x:0,y:0,pos:{x:0,y:0,window:{x:0,y:0},screen:{x:0,y:0},last:{x:0,y:0,window:{x:0,y:0},down:{x:0,y:0,window:{x:0,y:0}},up:{x:0,y:0,window:{x:0,y:0}}}}},e.events={move:["mousemove","touchmove"],down:["mousedown","touchstart"],up:["mouseup","touchend"]};var f={move:["mousemove","touchmove"],down:["mousedown","touchstart"],up:["mouseup","touchend"]};return e.onlyTouch=function(){return f.move=["touchmove"],f.down=["touchstart"],f.up=["touchend"],e},e.onlyMouse=function(){return f.move=["mousemove"],f.down=["mousedown"],f.up=["mouseup"],e},e.run=function(b){var d=c;"string"==typeof b&&(b=b.split(","));var b="object"==typeof b?b:[],g=e.state,h={init:function(e){if(d!==c||-1!==b.indexOf(e.type))return!1;if(3===e.which||2===e.button?g.right=!0:g.left=!0,e.changedTouches&&e.changedTouches[0])var f=e.changedTouches[0].clientX,h=e.changedTouches[0].clientY;else var f=e.clientX,h=e.clientY;if(g.pos.last.window.x=g.pos.window.x,g.pos.last.window.y=g.pos.window.y,g.pos.window.x=f,g.pos.window.y=h,c!==window){var i=a(c);f-=i[0],h-=i[1]}return g.x===f&&g.y===h?!1:(g.pos.last.x=g.x,g.pos.last.y=g.y,g.x=g.pos.x=f,g.y=g.pos.y=h,g.pos.screen.x=e.screenX,g.pos.screen.y=e.screenY,!0)},move:function(a){h.init(a)||d.removeEventListener(a.type,h.move),g.moving=!0;var b=20;setTimeout(function(){g.moving&&(g.moving=!1)},b)},down:function(a){g.right=!1,g.left=!1,h.init(a)||d.removeEventListener(a.type,h.down),g.down=!0,g.up=!1,g.pos.last.down.x=g.x,g.pos.last.down.y=g.y,g.pos.last.down.window.x=g.pos.window.x,g.pos.last.down.window.y=g.pos.window.y},up:function(a){h.init(a)||d.removeEventListener(a.type,h.up),g.down=!1,g.up=!0,g.pos.last.up.x=g.x,g.pos.last.up.y=g.y,g.pos.last.down.window.x=g.pos.window.x,g.pos.last.down.window.y=g.pos.window.y}};for(var i in f)for(var j in f[i])c.removeEventListener(f[i][j],h[i]),c.addEventListener(f[i][j],h[i],!0);return e},e.on=function(){return d.on.apply(e,b(arguments))},e.one=function(){return d.one.apply(e,b(arguments))},e.off=function(){return d.off.apply(e,b(arguments))},e}()};Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b){var c;if(pivot=b?b:0,!this)throw new TypeError;if(length=this.length,0===length||pivot>=length)return-1;for(0>pivot&&(pivot=length-Math.abs(pivot)),c=pivot;length>c;c++)if(this[c]===a)return c;return-1}),function(){for(var a=0,b=["webkit","moz"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}(),Object.keys=Object.keys||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var b=[];for(var c in a)Object.prototype.hasOwnProperty.call(a,c)(a,c)&&b.push(c);return b},Math.avg=Math.avg||function(){var a=0;for(var b in arguments)a+=arguments[b];return a/arguments.length};var c=function(){var a=Date.now(),b=a,c=0,d=1/0,e=0,f=0,g=1/0,h=0,i=0,j=0,k=document.createElement("div");k.id="stats",k.addEventListener("mousedown",function(a){a.preventDefault(),p(++j%2)},!1),k.style.cssText="width:80px;opacity:0.9;cursor:pointer";var l=document.createElement("div");l.id="fps",k.appendChild(l);var m=document.createElement("div");m.id="fpsText",m.innerHTML="FPS",l.appendChild(m);var n=document.createElement("div");n.id="ms",n.style.cssText="display:none",k.appendChild(n);var o=document.createElement("div");o.id="msText",o.innerHTML="MS",n.appendChild(o);var p=function(a){switch(j=a){case 0:l.style.display="block",n.style.display="none";break;case 1:l.style.display="none",n.style.display="block"}};return{REVISION:11,domElement:k,setMode:p,begin:function(){a=Date.now()},end:function(){var j=Date.now();return c=j-a,d=Math.min(d,c),e=Math.max(e,c),o.textContent=c+" MS ("+d+"-"+e+")",i++,j>b+1e3&&(f=Math.round(1e3*i/(j-b)),g=Math.min(g,f),h=Math.max(h,f),m.textContent=f+" FPS ("+g+"-"+h+")",b=j,i=0),j},update:function(){a=this.end()}}};(function(){var a=this;if(a._)return a._;var b={},c=function(a){return a instanceof c?a:this instanceof c?(this._wrapped=a,void 0):new c(a)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=c),exports._=c):a._=c,c.each=function(a,d,e){if(null!=a){if("number"==typeof a)for(var f=0;a>f;f++)d(f);if(Array.prototype.forEach&&a.forEach===Array.prototype.forEach)a.forEach(d,e);else if(a.length===+a.length){for(var f=0,g=a.length;g>f;f++)if(d.call(e,a[f],f,a)===b)return}else for(var h=c.keys(a),f=0,g=h.length;g>f;f++)if(d.call(e,a[h[f]],h[f],a)===b)return}},c.flatten=function(a){for(var b=[],c=0,d=a.length;d>c;c++){var e=Object.prototype.toString.call(a[c]).split(" ").pop().split("]").shift().toLowerCase();e&&(b=b.concat(/^(array|collection|arguments|object)$/.test(e)?flatten(a[c]):a[c]))}return b},c.contains=function(a,b){if(Array.isArray(b)){for(var c=0;c<b.length;c++)if(contains(a,b[c]))return!0;return!1}return Array.isArray(a)?-1!==flatten(a).indexOf(b):a[b]?!0:!1},c.clone=function(a){return a instanceof Array?a.slice(0):c.extend({},a)},c.has=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)},c.keys=Object.keys||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var b=[];for(var d in a)c.has(a,d)&&b.push(d);return b},c.extend=function(a){return c.each(Array.prototype.slice.call(arguments,1),function(b){if(b)for(var c in b)a[c]=b[c]}),a};var d=function(a,b,e,f){if(a===b)return 0!==a||1/a==1/b;if(null==a||null==b)return a===b;a instanceof c&&(a=a._wrapped),b instanceof c&&(b=b._wrapped);var g=toString.call(a);if(g!=toString.call(b))return!1;switch(g){case"[object String]":return a==String(b);case"[object Number]":return a!=+a?b!=+b:0==a?1/a==1/b:a==+b;case"[object Date]":case"[object Boolean]":return+a==+b;case"[object RegExp]":return a.source==b.source&&a.global==b.global&&a.multiline==b.multiline&&a.ignoreCase==b.ignoreCase}if("object"!=typeof a||"object"!=typeof b)return!1;for(var h=e.length;h--;)if(e[h]==a)return f[h]==b;var i=a.constructor,j=b.constructor;if(i!==j&&!(c.isFunction(i)&&i instanceof i&&c.isFunction(j)&&j instanceof j))return!1;e.push(a),f.push(b);var k=0,l=!0;if("[object Array]"==g){if(k=a.length,l=k==b.length)for(;k--&&(l=d(a[k],b[k],e,f)););}else{for(var m in a)if(c.has(a,m)&&(k++,!(l=c.has(b,m)&&d(a[m],b[m],e,f))))break;if(l){for(m in b)if(c.has(b,m)&&!k--)break;l=!k}}return e.pop(),f.pop(),l};c.isEqual=function(a,b){return d(a,b,[],[])},c.isObj=function(a){return"[object Object]"===Object.prototype.toString.call(a)},c.isArr=function(a){return Array.isArray(a)},c.omit=function(a){var b={},d=Array.prototype.concat.apply(Array.prototype,Array.prototype.slice.call(arguments,1));for(var e in a)c.contains(d,e)||(b[e]=a[e]);return b}}).call(this),a.Object=a.Class.extend({initialize:function(a,b){this.mergeValues(a,b),this.addToStage!==!1&&this.add(this.addToCollection),delete this.addToCollection,delete this.addToStage},mergeValues:function(b,c){if(b||c){var d={};for(var e in b)if(_.isObj(b[e])||_.isArr(b[e]))try{d[e]=JSON.parse(JSON.stringify(b[e]))}catch(f){d[e]=_.isArr(b[e])?b[e].slice(0):_.extend({},b[e])}else d[e]=b[e];b=d;var g={collections:[],events:!0},h=g,c=c||{};h=_.extend(h,c,b);for(var i in h){if("undefined"!=typeof b[i])if("object"==typeof b[i]&&"object"==typeof h[i])for(var j in b[i])try{h[i][j]=b[i][j]}catch(f){}else h[i]=b[i];this[i]="object"==typeof h[i]&&h[i].x&&h[i].y&&2===_.keys(h[i]).length?new a.Vector(h[i].x,h[i].y):h[i]}}},add:function(b){if(b===!1)return!1;if(b&&b instanceof a.Collection){var c=b.add(this);"number"==typeof c&&(this.events&&this.trigger("add",b),b.addToObjectCollections!==!1&&-1===this.collections.indexOf(b)&&this.collections.push(b))}else this.collections&&this.collections.length>0&&_.each(this.collections,function(a){var b=a.add(this);"number"==typeof b&&this.events&&this.trigger("add",a)},this);if(a.stage&&this.addToStage!==!1&&1===a.stages.length){var c=a.stage.add(this);"number"==typeof c&&this.events&&(this.events&&this.trigger("add",a.stage),a.stage.addToObjectCollections!==!1&&-1===this.collections.indexOf(a.stage)&&this.collections.push(a.stage)),"undefined"!=typeof c&&(this.stageId=c)}return this},remove:function(b){"boolean"==typeof b&&(b=void 0);var c=this;if(b&&b instanceof a.Collection){var d=b.remove(this);"number"==typeof d&&this.events&&this.trigger("remove",b)}else this.collections&&this.collections.length>0&&_.each(this.collections,function(a){var b=a.remove(c);"number"==typeof b&&c.events&&c.trigger("remove",a)});if(!b&&this.stage){var d=this.stage.remove(this);"number"==typeof d&&this.events&&this.trigger("remove",this.stage)}},set:function(b,c){var d=this;if("object"==typeof b)return _.each(arguments[0],function(a,b){d.set(b,a)}),d;var e=this;if(-1!==b.indexOf(".")){for(var f=b.split("."),g=0;g<f.length-1;g++)e=e[f[g]];b=f.pop()}var h=e[b];if(("object"!=typeof c&&c!==h||"object"==typeof c&&c!==h)&&(e[b]="object"!=typeof c||c instanceof a.Object?c:JSON.parse(JSON.stringify(c)),this.events)){this.trigger("change",[h,b]),this.trigger("change:"+b,[h,b]);for(var g=0;g<this.collections.length;g++)this.collections[g].events&&(this.collections[g].trigger("change:any",[h,b]),this.collections[g].trigger("change:"+b,[h,b]))}return d},get:function(a){return"undefined"==typeof this[a]?!1:"object"==typeof this[a]?_.clone(obj):this[a]},update:function(){}}),a.Camera=a.Class.extend({initialize:function(b){this.stage=b.stage?b.stage:a.stage;var c={pos:new a.Vector,vel:{x:0,y:0},scrollRatio:{x:2,y:2},focus:0,frame:{left:0,right:this.stage.width,top:0,bottom:this.stage.height},bounds:{left:0,right:this.stage.width,top:0,bottom:this.stage.height}};for(i in c)this[i]=c[i];for(i in b)this[i]=b[i]},translate:function(){this.trigger("update"),this.focus&&this.focus.pos&&(this.pos.x=this.focus.pos.x-this.frame.right/this.scrollRatio.x,this.pos.y=this.focus.pos.y-this.frame.bottom/this.scrollRatio.y),"number"==typeof this.bounds.left&&this.pos.x+this.frame.left<this.bounds.left&&(this.pos.x=this.bounds.left),"number"==typeof this.bounds.top&&this.pos.y+this.frame.top<this.bounds.top&&(this.pos.y=this.bounds.top),"number"==typeof this.bounds.right&&this.pos.x+this.frame.right>this.bounds.right&&(this.pos.x=this.bounds.right-this.frame.right),"number"==typeof this.bounds.bottom&&this.pos.y+this.frame.bottom>this.bounds.bottom&&(this.pos.y=this.bounds.bottom-this.frame.bottom);var b=this.stage?this.stage.ctx:this.focus?this.focus.stage?this.focus.stage.ctx:!1:a.stage?a.stage.ctx:!1;return b?(b.translate(-this.pos.x,-this.pos.y),void 0):!1},resetTranslation:function(){var b=this.stage?this.stage.ctx:this.focus?this.focus.stage?this.focus.stage.ctx:!1:a.stage?a.stage.ctx:!1;return b?(b.translate(this.pos.x,this.pos.y),void 0):!1}}),a.Collection=a.Class.extend({initialize:function(b,c,d){this.objects=[],this._currentId=0,this._length=0,this._visibleHashEnabled=!1,this.addToCollections="boolean"==typeof b?b:"object"==typeof b&&"boolean"==typeof b.addToCollections?b.addToCollections:!0,this.addToObjectCollections="boolean"==typeof c?c:"object"==typeof addToSCollections&&"boolean"==typeof b.addToObjectCollections?b.addToObjectCollections:!0,this.add.apply(this,arguments),this.addToCollections!==!1&&(a.collections.push(this),this._initLoader()),this.events=!0;var e=this.addToCollections;e&&"undefined"!=typeof e.events&&!e.events&&(this.events=!1),(d||"object"==typeof arguments[0]&&arguments[0].physics)&&(this.physics=!0,this.world=new a.Physics.World(arguments[0].physics||d))},_initLoader:function(){function b(){d.length()===e.length()?(c.loaded=!0,c.events&&c.trigger("load",[d]),c===a.stage&&a.events&&a.trigger("load",[d])):(c.events&&c.trigger("loading",[f,e,d]),c===a.stage&&a.events&&a.trigger("loading",[f,e,d]))}var c=this,d=new a.Collection(!1,!1),e=new a.Collection(!1,!1),f=new a.Collection(!1,!1);this.loaded=!0,this.on("add",function(a){a.src&&(d.add(a),a.loaded?e.add(a):(c.loaded=!1,f.add(a),a.on("load",function(){f.remove(a),e.add(a),b(a)})),b(a))})},config:function(b){return"object"!=typeof b?!1:(b.physics&&b.physics&&(this.world?this.world.config(b.Physics):this.world=new a.Physics.World(b.physics)),void 0)},update:function(){return this.trigger("update"),this.world&&(this!==a.stage&&this.physics||this===a.stage&&a.physics&&this.physics)&&this.world.update(),this.each(function(a){a.update&&a.update()}),this},render:function(){if(!this.isPaused){var b=this;if(b.events&&b.trigger("render"),this.visibleHash&&this._visibleHashEnabled){this.visibleHash.moving.clear().insert(this.visibleHash.moving.shapes);var c={};if(this.visibleHash.stage.camera){var d=this.visibleHash.stage.camera;c.bounds=function(){return{top:d.pos.y-d.frame.top,left:d.pos.x-d.frame.left,bottom:d.pos.y+d.frame.bottom,right:d.pos.x+d.frame.right}}}else c.bounds=function(){return{top:0,left:0,bottom:b.visibleHash.stage.height,right:b.visibleHash.stage.width}};return _.each(this.visibleHash.static.retrieve(c),function(a){a&&("static"!==a.type&&_.each(b.visibleHash.static.retrieve(),function(a){"static"!==a.type&&(b.visibleHash.static.remove(a),b.visibleHash.moving.insert(a),b.visibleHash.moving.shapes.push(a))}),b.events&&b.trigger("renderShape",[a]),a.render())}),_.each(this.visibleHash.moving.retrieve(c),function(a){a&&("static"===a.type&&_.each(b.visibleHash.moving.retrieve(),function(a){if("static"===a.type){b.visibleHash.moving.remove(a);var c=b.visibleHash.moving.shapes.indexOf(a);-1!==c&&b.visibleHash.moving.shapes.splice(c,1),b.visibleHash.static.insert(a)}}),b.events&&b.trigger("renderShape",[a]),a.render())}),this}for(var e=0;e<this.objects.length;e++){var f=this.objects[e];f instanceof a.Shape&&(b.events&&b.trigger("renderShape",[f]),f.render())}return this}},add:function(b){if(_.isArr(b)){for(var c=0;c<b.length;c++)this.add(b[c]);return this}var d=this;if(arguments.length>1)for(var c=0;c<arguments.length;c++)(arguments[c]instanceof Array||arguments[c]instanceof a.Object)&&this.add(arguments[c]);else if(b instanceof Array)for(var c=0;c<b.length;c++)b[c]instanceof a.Object&&this.add(b[c]);else{if(!(b instanceof a.Collection)){if(!(b instanceof a.Object))return!1;if(this.world&&this.physics!==!1&&this.world.add(b),this.has(b))return!1;if(!(b instanceof a.Object))return!1;var e=this._currentId;if(this.objects[e]=b,this._currentId++,this._length=this._length+1,"undefined"!=typeof b.zindex&&this.enableZindex){for(var f=!1,c=0;c<this.objects.length;c++)if(this.objects[c]&&0!==this.objects[c].zindex){f=!0;break}f&&this.sortByZindex()}return this._visibleHashEnabled&&(this.canvas||this.get(0)&&this.get(0).stage&&this.get(0).stage.canvas)&&b instanceof a.Shape&&this.addToVisibleHash(b),b.collections&&this.addToObjectCollections!==!1&&-1===b.collections.indexOf(this)&&b.collections.push(this),this instanceof a.Stage&&(b.stage=this),this.events&&this.trigger("add",arguments),this.events&&this.trigger("change",arguments),e}b.each(function(a){d.add(a)})}},remove:function(b,c){if(_.isArr(b)){for(var d=0;d<b.length;d++)this.remove(b[d]);return this}if(0===this.length())return!1;if("number"==typeof b&&(b=this.get(b)),b instanceof a.Object&&!this.has(b))return!1;var e=this;if(!b||"boolean"==typeof b){for(var f=0,g=[],d=0,h=this.objects.length;h>d;d++){var b=this.objects[d];g.push(b),e.remove(b),b&&b.remove()}return g}this.world&&this.physics!==!1&&this.world.remove(b);var f=this.getId(b);if(this.events&&this.trigger("remove",arguments),this.events&&this.trigger("change",arguments),this.objects.splice(f,1),this._currentId=this.objects.length,this._length=this._length-1,this.enableVisibleHash&&b instanceof a.Shape&&this.visibleHash&&this.removeFromVisibleHash(b),!b.collections||b.collections&&0===b.collections.length)return b;var f=b.collections.indexOf(this);return-1!==f&&(b.collections.splice(f,1),!c&&b.events&&b.trigger("remove",this)),(this===a.stage||this.queryParent===a.stage)&&b.remove(),b},sortByZindex:function(){this.objects.sort(function(a,b){return a.zindex>b.zindex?1:a.zindex===b.zindex?0:-1})},addToVisibleHash:function(a){{var b=this.canvas?this:this.get(0).stage;b.canvas,a.bounds()}this.visibleHash||(this.visibleHash={stage:b,"static":(new f).setCellSize(b.width,b.height),moving:(new f).setCellSize(b.width,b.height)},this.visibleHash.moving.shapes=[]),"static"===a.type?this.visibleHash.static.insert(a):(this.visibleHash.moving.insert(a),this.visibleHash.moving.shapes.push(a))},removeFromVisibleHash:function(a){if("static"===a.type)this.visibleHash.static.remove(a);else{this.visibleHash.static.remove(a),this.visibleHash.moving.remove(a);var b=this.visibleHash.moving.shapes.indexOf(a);-1!==b&&this.visibleHash.moving.shapes.splice(b,1)}},enableVisibleHash:function(){this._visibleHashEnabled=!0;var a=this;this.each(function(b){a.addToVisibleHash(b)})},disableVisibleHash:function(){this._visibleHashEnabled=!1;var a=this;this.each(function(b){a.removeFromVisibleHash(b)})},has:function(a){if(a instanceof Array)var b=a.map(function(a){return this.has(a)},this);else b=-1!==this.objects.indexOf(a);return b},get:function(a){if("number"==typeof a){if(a>=0)return this.objects[a];var b=0;for(b=this.objects.length-1;b>0&&!this.objects[b];b--);return this.objects[b+1+a]}if(-1===this.objects.indexOf(void 0))return this.objects.slice(0);for(var c=[],b=0;b<this.objects.length;b++){var d=this.objects[b];d&&c.push(d)}return c},getId:function(a){return this.objects.indexOf(a)},each:function(a){for(var b=0,c=this.objects.length;c>b;b++)if("undefined"!=typeof this.objects[b]){var d=a.call(this.objects[b],this.objects[b],b);if(d===!1)break}return this},length:function(){if("number"==typeof this._length)return this._length;if(-1===this.objects.indexOf(void 0))return this.objects.length;for(var a=0,b=0;b<this.objects.length;b++)"undefined"!=typeof this.objects[b]&&a++;return this._length=cound,a},shapeContainingPoint:function(b,c,d){var e;return this.each(function(f){return f instanceof a.Shape?f.posInBounds(b,c,d)?(e=f,!1):void 0:void 0}),e?e:!1},getIntersections:function(){for(var b=this,c=function(){},d=!0,e=[],f=0;f<arguments.length;f++)arguments[f]instanceof a.Collection&&(b=arguments[f]),"function"==typeof arguments[f]&&(c=arguments[f]);return this.each(function(f){if(f instanceof a.Shape){var g=f.getIntersections(b,c);g&&(e.push([f,g]),d=!1)}}),d?!1:e},query:function(b,c){function d(a,b,c){if(c){var d=!1;if("string"==typeof a&&-1!==a.indexOf("range")){var d=a.split("range:").join("").split(":").map(function(a){return+a});l=d&&c[b]>=d[0]&&c[b]<=d[1]?!1:!0}d||c[b]===a||(l=!0)}}if("string"!=typeof b&&"object"!=typeof b&&"function"!=typeof b)return!1;if("string"==typeof b){var e=b.split(",");if("string"==typeof c){var f=c;c=arguments[2]}}if("function"==typeof b)var g=b;var c=c||function(){},h=new a.Collection(!1,!1);h.queryParent=this;for(var i=!0,j=0;j<this.objects.length;j++)if(this.objects[j]){var k=this.objects[j],l=!1;e?_.each(e,function(a){var b=k;if(-1!==a.indexOf(".")){for(var c=a.split("."),e=0;e<c.length-1;e++)b=b[c[e]];a=c.pop()}d(f,a,b)}):g?l=g(k)?!1:!0:_.each(b,function(a,b){var c=k;if(-1!==b.indexOf(".")){for(var e=b.split("."),f=0;f<e.length-1;f++)c=c[e[f]];b=e.pop()}"object"==typeof a?_.each(a,function(a,e){d(a,e,c[b])}):d(a,b,c)}),l||(c.call(k,k,b),h.add(k),i=!1)}return h}}),a.config=function(b){return"object"!=typeof b?!1:(b.physics&&("boolean"==typeof b.physics?a.physics=b.physics:"object"==typeof b.physics&&(a.physics=!0,"number"==typeof b.physics.gravity&&(a.gravity=new a.Vector(a.gravity?a.gravity.x:0,b.physics.gravity)),"object"==typeof b.physics.gravity&&(a.gravity=new a.Vector(b.physics.gravity.x,b.physics.gravity.y)),"number"==typeof b.physics.cellSize&&(a.cellSize=b.physics.cellSize))),"boolean"==typeof b.showFramerate&&(a.showFramerate=b.showFramerate,a.stage&&(a.stage.showFramerate=b.showFramerate)),void 0)};var d=a.Shape=a.Object.extend({initialize:function(b){return"string"==typeof b&&-1!==["bounds","circle","rect","polygon","image","sprite","text","line"].indexOf("type")?new(a[b[0].toUpperCase()+b.substr(1)])(Array.prototype.slice.call(arguments,1)):(this._super.apply(this,arguments),void 0)},mergeValues:function(b,c){var c=_.extend({pos:new a.Vector,vel:new a.Vector,width:0,height:0,rotation:0,zindex:0,color:"#000",fill:!0,hidden:!1},c||{});this._super(b,c);(function(){var a=this.zindex;Object.defineProperty(this,"zindex",{get:function(){return a},set:function(b){a=b,this.stage&&this.stage.sortByZindex(),_.each(this.collections,function(a){a.sortByZindex()})}.bind(this)})}).bind(this)(),function(){"undefined"!=typeof this.width&&"undefined"!=typeof this.height&&"undefined"!=typeof this.pos.x&&"undefined"!=typeof this.pos.y&&"undefined"==typeof this.bounds.left&&(Object.defineProperty(this.bounds,"top",{set:function(a){this.pos.y=a+this.height/2}.bind(this),get:function(){return this.pos.y-this.height/2}.bind(this)}),Object.defineProperty(this.bounds,"left",{set:function(a){this.pos.x=a+this.width/2}.bind(this),get:function(){return this.pos.x-this.width/2}.bind(this)}),Object.defineProperty(this.bounds,"bottom",{set:function(a){this.pos.y=a-this.height/2}.bind(this),get:function(){return this.pos.y+this.height/2}.bind(this)}),Object.defineProperty(this.bounds,"right",{set:function(a){this.pos.x=a-this.width/2}.bind(this),get:function(){return this.pos.x+this.width/2}.bind(this)}))}.bind(this)(),function(){var b=this.physics,c=Object.getOwnPropertyDescriptor(this,"physics");return c&&c.configurable===!1?!1:(Object.defineProperty(this,"physics",{set:function(c){b=c,this.stage&&this.stage.world&&this.stage.world instanceof a.Physics.World&&(c?this.stage.world.add(this):this.stage.world.remove(this))},get:function(){return b}}),void 0)}.bind(this)()},bounds:function(a){if(a){if("object"!=typeof a)return;for(var b in a)"top"===b?this.pos.y=a[b]+this.height/2:"bottom"===b?this.pos.y=a[b]-this.height/2:"left"===b?this.pos.x=a[b]+this.width/2:"right"===b&&(this.pos.x=a[b]-this.width/2);
return this}if(!this.width)return!1;var c=this.width/2,d=this.height/2,a={};return a.left=this.pos.x-c,a.right=this.pos.x+c,a.top=this.pos.y-d,a.bottom=this.pos.y+d,a},posInBounds:function(b,c){for(var d=.01,e=!1,f=2;f<arguments.length;f++){if("number"==typeof arguments[f])var d=arguments[f];"boolean"==typeof arguments[f]&&(e=arguments[f])}var g=this.bounds();if("rect"===this.shape)return b>g.left&&b<g.right&&c>g.top&&c<g.bottom;var h=new a.Circle({pos:{x:b,y:c},radius:d,addToStage:!1,hidden:!0});return a.Physics.intersecting(h,this,e)},getIntersections:function(){function b(b){b.each(function(b){var c=a.Physics.intersecting(b,h);c&&(d(c,b),f.push([c,b]),e=!1)})}for(var c=a.stage,d=function(){},e=!0,f=[],g=0;g<arguments.length;g++)(arguments[g]instanceof a.Stage||Array.isArray(arguments[g]))&&(c=arguments[g]),"function"==typeof arguments[g]&&(d=arguments[g]);var h=this;if(Array.isArray(c))for(var g=0;g<c.length;g++)b(c[g]);else b(c);return e?!1:f},update:function(){this.trigger("update",[])},render:function(){if(this.loaded!==!1&&this.hidden!==!0){if(this.stage&&!this.stage.ctx&&!a.stage.ctx)throw new Error("No canvas to render to.");return this.events&&this.trigger("render",arguments),a.events&&a.trigger("renderShape",[this]),0!==this.rotation?this.rotate(this.rotation):this._render(),this}},rotate:function(b){var c=this.stage.ctx||a.stage.ctx;this.events&&this.trigger("rotate",arguments),c.save(),c.translate(this.pos.x,this.pos.y),c.rotate(b),this._render(0,0),c.restore()},hide:function(){this.events&&this.trigger("hide",arguments),this.hidden=!0},show:function(){this.events&&this.trigger("show",arguments),this.hidden=!1},toggleHidden:function(){this.hidden&&this.events?this.trigger("show",arguments):this.events&&this.trigger("hide",arguments),this.hidden=!this.hidden}});!function(a){function b(a){return""!==e.canPlayType(f[a])}var c=window.AudioContext||window.webkitAudioContext,d=c?new c:{},e=new Audio,f={mp3:"audio/mpeg",ogg:"audio/ogg",wav:"audio/wav"};a.Sound=a.Object.extend({initialize:function(c,e){function f(){var a=new Audio;return a.src=g.src,a}this._super();var g=this;if("string"!=typeof c)return console.warn("Warning: A sound must have a source... ",this);if(e instanceof Array){for(var h=0;h<e.length;h++)if(b(e[h],j)){this.src=c+"."+e[h];break}}else this.src=c;this.multipleChannels=!0;for(var h=0;h<arguments.length;h++)"boolean"==typeof arguments[h]&&(this.multipleChannels=arguments[h]);for(var i=this.channels=[],h=0;4>h;h++)i.push(f());this.currentChannel=0;var j=this.audio=i[0];if(this.loaded=!1,j.addEventListener("canplaythrough",function(){g.trigger("load")}),this.on("load",function(){g.loaded=!0}),d&&null!==navigator.userAgent.match("Safari")&&null===navigator.userAgent.match("Chrome")){this.context=d;for(var h in i)i[h]=d.createMediaElementSource(i[h]).mediaElement}this.playing=!1,j.addEventListener("play",function(){g.playing=!0}),j.addEventListener("ended",function(){g.playing=!1}),a.isMobile&&a.stages[0]&&a.stages[0].event.one("touchstart",window,function(){j.muted=!0,j.play(),j.muted=!1})},play:function(a){var b=this.audio,c=this.channels;return this.playing&&this.multipleChannels!==!1?(this.currentChannel++,this.currentChannel>3&&(this.currentChannel=0),c[this.currentChannel].play(a)):this.loaded?b.play(a):this.on("load",function(){self.play(a)})},pause:function(a){var b=(this.audio,this.channels);if(!this.loaded&&!this.playing)return!1;for(var c in b)b[c].pause(a)}})}(a),a.animate=function(b){return a.stage.animate(b),a.stage.on("animate",function(){a.framerate=a.stage.framerate,a.deltaFramerate=a.stage.deltaFramerate,a.deltaTime=a.stage.deltaTime,a.desiredFramerate=a.stage.desiredFramerate,a.trigger("animate",arguments)}),this},a.pause=function(){return a.stage.pause()!==!1&&(a.isPaused=!0,a.trigger("pause",arguments)),this},a.unPause=function(){return a.stage.unPause(),a.isPaused=!1,a.trigger("unpause",arguments),this},a.togglePaused=function(){return a.isPaused?a.unPause():a.pause(),this},a.update=function(){return 0===a.stage.length()?!1:(a.trigger("update"),a.stage.update(),_.each(a.collections,function(a){a.update()}),this)},a.render=function(b){return 0===a.stage.length()?!1:(a.trigger("render"),a.stage.render(b),this)},a.setCanvas=function(){a.stage||(new a.Stage,a.stage.event=a.event),a.stage.setCanvas.apply(a.stage,arguments),this.canvas=a.stage.canvas,this.ctx=a.stage.ctx,a.showFramerate&&(a.stage.showFramerate=!0),"number"==typeof a.desiredFramerate&&(a.stage.desiredFramerate=a.desiredFramerate),a.framerate=a.stage.framerate,a.deltaFramerate=a.stage.deltaFramerate,a.deltaTime=a.stage.deltaTime,a.desiredFramerate=a.stage.desiredFramerate},a.clearCanvas=function(){this.stage.clearCanvas()},a.getCanvas=function(){return this.canvas||(a.stage?a.stage.canvas:!1)},a.getContext=function(){return this.ctx||(a.stage?a.stage.canvas:!1)},function(a){function d(a){var b=new c;return document.body.appendChild(b.domElement),b.domElement.style.cssText="padding:3px;z-index:100;position:absolute;left:"+a[0]+"px;top:"+a[1]+"px;cursor:pointer;background-color:#fff;font: 12px 'Helvetica Neue', Helvetica, Arial, sans-serif;",b}function e(a){a.domElement&&a.domElement.parentNode===document.body&&document.body.removeChild(a.domElement)}a.Stage=a.Collection.extend({initialize:function(c){0===a.stages.length?(a.stage=this,this.name="G Main Stage"):(delete a.stage,delete a.stages[0].name),this.objects=[],this.physics=!1,this._currentId=0,this._length=0,this._initLoader(),this.addToCollections=!1,this.addToObjectCollections=!1,this.events=!0,this.enableZindex=!0,this._visibleHashEnabled=!1,c&&"undefined"!=typeof c.events&&!c.events&&(this.events=!1),this.event=new b,this.framerate=this.desiredFramerate=60,this.timeScale=1,this.deltaFramerate=1,this.deltaTime=1e3/this.framerate,this.time=0,a.stage&&this===a.stage&&(this.showFramerate=a.showFramerate),(c&&c.physics||0===a.stages.length&&a.physics)&&(this===a.stage&&(a.physics=!0),this.physics=!0,this.world=new a.Physics.World(c?c.physics:a.physics)),this.backgroundColor="",a.stages.push(this)},config:function(b){return"object"!=typeof b?!1:(b.physics&&b.physics&&(this.world?this.world.config(b.Physics):this.world=new a.Physics.World(b.physics)),"boolean"==typeof b.showFramerate&&(this===a.stage&&(a.showFramerate=b.showFramerate),this.showFramerate=b.showFramerate),b.camera&&(this.camera?this.camera.initialize(_.extend(b.camera,{stage:this})):this.camera=new a.Camera(_.extend(b.camera,{stage:this}))),void 0)},setCanvas:function(){var b=[];_.each(arguments,function(a){b.push(a)});for(var c=this.canvas?!1:!0,d=0;d<b.length;d++){var e=b[d];if(!this.canvas&&!this.ctx){if(e.tagName&&"CANVAS"===e.tagName)this.canvas=e;else if("string"==typeof e&&"smooth"!==e&&"crisp"!==e&&"lowres"!==e){if(this.canvas=document.querySelector(e),!this.canvas||"CANVAS"!==this.canvas.tagName)throw new Error("Selector does not match a canvas"+e)}else this.canvas=document.body.appendChild(document.createElement("canvas")),this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight;this.ctx=this.canvas.getContext("2d")}"number"==typeof e&&this.canvas&&("number"==typeof b[d+1]?(this.canvas.width=b[d],this.canvas.height=b[d+1],d++):this.canvas.width=b[d])}this.canvas||this.ctx||(this.canvas=document.body.appendChild(document.createElement("canvas")),this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.ctx=this.canvas.getContext("2d")),-1!==b.indexOf("smooth")?(this.canvas.style.imageRendering="",this.canvas.style.msInterpolationMode=""):-1!==b.indexOf("crisp")&&(this.canvas.style.imageRendering="-moz-crisp-edges",this.canvas.style.imageRendering="-o-crisp-edges",this.canvas.style.imageRendering="-webkit-optimize-contrast",this.canvas.style.imageRendering="crisp-edges",this.canvas.style.msInterpolationMode="nearest-neighbor"),c&&(this.width=this.canvas.width=this.canvas.clientWidth,this.height=this.canvas.height=this.canvas.clientHeight);var f=window.devicePixelRatio||1,g=this.ctx.webkitBackingStorePixelRatio||this.ctx.mozBackingStorePixelRatio||this.ctx.msBackingStorePixelRatio||this.ctx.oBackingStorePixelRatio||this.ctx.backingStorePixelRatio||1,h=f/g;return-1===Array.prototype.indexOf.call(arguments,"lowres")&&f!==g&&this.setScale(h),this.event.mouse.setRoot(this.canvas).run(),a.isMobile&&this.event.mouse.onlyTouch().on("touchstart,touchend,touchmove",function(a){a.preventDefault()}),this.clearCanvas(),this},getCanvasOffset:function(){var a=this.canvas;if(!a)return!1;try{var b=a.getBoundingClientRect()}catch(c){throw new Error("Invalid DOM Element")}var d=b.left,e=b.top;return[d,e]},clearCanvas:function(){return this.canvas&&this.ctx&&(this._canvasCleared=!0,""===this.backgroundColor?this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height):(this.ctx.fillStyle=this.backgroundColor,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height))),this},setScale:function(a,b){if(this.ctx&&"number"==typeof a){var c=this.canvas,d=this.ctx;if("number"!=typeof b)var b=a;var e=c.width,f=c.height;c.width=e*a,c.height=f*b,c.style.width=e+"px",c.style.height=f+"px",this.width=e,this.height=f,d.scale(a,b)}},render:function(a){return this.isPaused?void 0:(a===!1&&this._canvasCleared||(this._canvasCleared=!0,this.clearCanvas()),this._super.apply(this,arguments),this)},animate:function(a){var b=this;if(this._canvasCleared=!1,"function"==typeof a){if(this._events.animate)return this.on("animate",a);this.on("animate",a)}if(this.camera&&(this.clearCanvas()._canvasCleared=!0,this.camera.translate()),this.trigger("animate",arguments),this.camera&&this.camera.resetTranslation(),"number"==typeof a){var c=Math.avg(this.deltaTime,a-this.time);this.deltaTime=Math.abs(c-this.deltaTime)>10?this.deltaTime:c,this.framerate=1e3/this.deltaTime,this.deltaFramerate=this.desiredFramerate/this.framerate*this.timeScale,this.time=a}if(this.showFramerate!==!0||this.stats?this.showFramerate&&this.stats?this.stats.update():!this.showFramerate&&this.stats&&e(this.stats):this.stats=d(this.getCanvasOffset()),!this.isPaused)if(60===this.desiredFramerate)this._animFrameId=window.requestAnimationFrame(function(a){b.animate.call(b,a)});else{var f=(new Date).getTime(),g=Math.max(0,1e3/this.desiredFramerate-(f-this.time));this._animFrameId=window.setTimeout(function(){b.animate.call(b,f+g)},g)}},pause:function(){return this.isPaused=!0,60===this.desiredFramerate?window.cancelAnimationFrame(this._animFrameId):window.clearTimeout(this._animFrameId),this.trigger("pause",arguments),this},unPause:function(){return"undefined"==typeof this.isPaused?!1:(this.isPaused=!1,this.framerate=this.desiredFramerate,this.deltaFramerate=1,this.deltaTime=1e3/this.framerate,this.animate(!0),this.trigger("unpause",arguments),this)},togglePaused:function(){return this.isPaused?this.unPause():this.pause(),this}})}(a),a.Ticker=a.Class.extend({initialize:function(a){this.interval=a||1e3/60;for(var b=0;b<arguments.length;b++)"function"==typeof arguments[b]&&this.on("tick",arguments[b]),"number"==typeof arguments[b]&&(this.interval=arguments[b]);return this},start:function(a){var b=this;if("number"==typeof a||this.isStopped!==!1)return"number"!=typeof a&&this.isStopped===!0&&(this.isStopped=!1,this._time=Date.now(),this.trigger("start")),this._time||this.trigger("start"),this._time||(this._time=Date.now()),this.elapsedTime||(this.elapsedTime=0),this.deltaTime=Date.now()-this._time,this.elapsedTime=parseFloat((this.elapsedTime+this.deltaTime/1e3).toFixed(3)),this._time=Date.now(),this.trigger("tick",arguments),this.isStopped||(this.interval===1e3/60?window.requestAnimationFrame(function(a){b.start.call(b,a)}):window.setTimeout(function(){b.start.call(b,b.elapsedTime)},this.interval)),this},stop:function(){this.isStopped=!0,this.trigger("stop")},reset:function(){this.elapsedTime=0,this.trigger("reset")}}),a.Rect=d.extend({initialize:function(b){if("object"!=typeof b&&arguments.length>=4){var c={};c.pos=new a.Vector(arguments[0],arguments[1]),arguments[2]&&(c.width=arguments[2]),arguments[3]&&(c.height=arguments[3]),"string"==typeof arguments[4]&&(c.color=arguments[4]),"number"==typeof arguments[5]&&(c.vel={x:arguments[5]}),"number"==typeof arguments[6]&&c.vel&&(c.vel.y=arguments[6]),-1!==Array.prototype.indexOf.call(arguments,!1)&&(c.addToStage=!1);var b=arguments[0]=c}this.shape="rect",this._super&&this._super.apply(this,arguments),this.pos.y>this.pos.y+this.height&&(this.pos.y=this.pos.y+this.height,this.height=Math.abs(this.height)),this.pos.x>this.pos.x+this.width&&(this.pos.x=this.pos.x+this.width,this.width=Math.abs(this.width))},_render:function(b,c,d,e){var f=this.stage?this.stage.ctx:a.stage.ctx;f&&(this.thickness&&(f.lineWidth=this.thickness),this.fill?(f.fillStyle=this.color,void 0!==b&&void 0!==c?f.fillRect(b-this.width/2,c-this.width/2,this.width,this.height):void 0!==d&&void 0!==e?f.fillRect(b-d/2,c-e/2,d,e):f.fillRect(this.pos.x-this.width/2,this.pos.y-this.height/2,this.width,this.height)):(f.strokeStyle=this.strokeColor||this.color,void 0!==b&&void 0!==c?f.strokeRect(b-this.width/2,c-this.width/2,this.width,this.height):void 0!==d&&void 0!==e?f.strokeRect(b-d/2,c-e/2,d,e):f.strokeRect(this.pos.x-this.width/2,this.pos.y-this.height/2,this.width,this.height)))}}),a.Image=a.Rect.extend({initialize:function(b){function c(a){this.loaded=!0,0===this.width&&(this.width=this.image.naturalWidth),0===this.height&&(this.height=this.width/(this.image.naturalWidth/this.image.naturalHeight)),a||g.trigger("load")}if("string"==typeof arguments[0]){var d={};d.src=arguments[0],d.pos=new a.Vector(arguments[1],arguments[2]),arguments[3]&&(d.width=arguments[3]),arguments[4]&&(d.height=arguments[4]),arguments[5]&&(d.vel={x:arguments[5]}),arguments[6]&&d.vel&&(d.vel.y=arguments[6]),arguments[7]&&(d.clip=arguments[7]),-1!==Array.prototype.indexOf.call(arguments,!1)&&(d.addToStage=!1);var b=arguments[0]=d}else if("object"!=typeof b)throw new Error("You must pass in either an object or multiple arguments src,x,y,width,height,vx,vy");if(!b.src)throw new Error("A G.Image must have a 'src' attribute.");var e={src:"",clip:{x:0,y:0,width:0,height:0}},f=Array.prototype.slice.call(arguments,0);f[1]="object"==typeof f[1]?_.extend(f[1],e):e,this._super&&this._super.apply(this,f),b.image?c(!0):(this.image=new Image,this.image.src=this.src,this.loaded=!1,this.image.addEventListener("load",function(){c.call(g)}));var g=this,h=this.src;Object.defineProperty(this,"src",{get:function(){return h},set:function(a){h=a,this.image=new Image,this.image.src=h,this.loaded=!1,this.image.addEventListener("load",function(){c.call(g)})}})},_render:function(b,c,d,e){var f=this.stage?this.stage.ctx:a.stage.ctx;if(f&&this.loaded){if(void 0===b)var b=this.pos.x;if(void 0===c)var c=this.pos.y;if(void 0===d)var d=this.width;if(void 0===e)var e=this.height;0!==this.clip.width&&0!==this.clip.height?f.drawImage(this.image,this.clip.x,this.clip.y,this.clip.width,this.clip.height,b-d/2,c-e/2,d,e):f.drawImage(this.image,b-d/2,c-e/2,d,e)}}}),a.Bounds=function(){return a.Collection.extend({initialize:function(b,c,d,e,f,g,h){this._super(!1,!0),this.thickness=h||2;var i="boolean"==typeof i?i:!0;this.friction="number"==typeof g?g:0,this.restitution="number"==typeof f?f:0,arguments.length<4&&(arguments[2]&&(this.thickness=arguments[2]||this.thickness),arguments[1]&&(this.friction=arguments[1]||this.friction),arguments[0]&&(this.restitution=arguments[0]||this.restitution),b=0,d=a.stage.canvas?a.stage.width:0,c=0,e=a.stage.canvas?a.stage.height:0),this.name="Bounds Shape";for(var j={pos:{x:(d+b)/2,y:c},width:d-b,height:this.thickness,type:"static",hidden:i,friction:this.friction,restitution:this.restitution},k=0;k<arguments.length;k++)if("string"==typeof arguments[k])var l=arguments[k].split(",");var m,n,o,p;l&&-1!==l.indexOf("top")||(m=new a.Rect(j)),j.pos.x=b,j.pos.y=(e+c)/2,j.width=this.thickness,j.height=e-c,l&&-1!==l.indexOf("left")||(n=new a.Rect(j)),j.pos.x=(d+b)/2,j.pos.y=e,j.width=d-b,j.height=this.thickness,l&&-1!==l.indexOf("bottom")||(o=new a.Rect(j)),j.pos.x=d,j.pos.y=(e+c)/2,j.width=this.thickness,j.height=e-c,l&&-1!==l.indexOf("right")||(p=new a.Rect(j)),this.add(m,n,o,p);this.bounds={top:m,left:n,bottom:o,right:p},this.top=m,this.left=n,this.bottom=o,this.right=p},resize:function(){this.remove(!0),this.initialize.apply(this,arguments)}})}(),a.Circle=d.extend({initialize:function(b){if("object"!=typeof b&&arguments.length>2){var c={};c.pos=new a.Vector(arguments[0],arguments[1]),c.radius=arguments[2],"string"==typeof arguments[3]&&(c.color=arguments[3]),"number"==typeof arguments[4]&&(c.vel={x:arguments[4]}),"number"==typeof arguments[5]&&c.vel&&(c.vel.y=arguments[5]),-1!==Array.prototype.indexOf.call(arguments,!1)&&(c.addToStage=!1);var b=arguments[0]=c}this.shape="circle",this.radius=b.radius,this._super&&this._super.apply(this,arguments),this.width=this.height=2*this.radius},_render:function(b,c,d){var e=this.stage?this.stage.ctx:a.stage.ctx;if(e){if(this.fill?e.fillStyle=this.color:e.strokeStyle=this.strokeColor||this.color,this.thickness&&(e.lineWidth=this.thickness),void 0===b)var b=this.pos.x;if(void 0===c)var c=this.pos.y;if(void 0===d)var d=this.radius;e.beginPath(),e.arc(b,c,d,0,2*Math.PI,!1),this.fill?e.fill():e.stroke()}}}),a.Line=d.extend({initialize:function(a){var b={pos:{x1:0,y1:0,x2:0,y2:0,x:0,y:0},thickness:1,endStyle:"butt"};if("object"!=typeof a&&arguments.length>3){var c={};c.pos={x1:arguments[0],y1:arguments[1],x2:arguments[2],y2:arguments[3]},"string"==typeof arguments[4]&&(c.color=arguments[4]),"number"==typeof arguments[5]&&(c.thickness=arguments[5]),"number"==typeof arguments[6]&&(c.vel={x:arguments[6]}),"number"==typeof arguments[7]&&c.vel&&(c.vel.y=arguments[7]),-1!==Array.prototype.indexOf.call(arguments,!1)&&(c.addToStage=!1);var a=arguments[0]=c}this.shape="line",arguments[1]="object"==typeof arguments[1]?_.extend(arguments[1],b):b,this._super&&this._super.apply(this,arguments),this.setDimensions().setCenter()},bounds:function(){return{top:this.pos.y1,left:this.pos.x1,right:this.pos.x1+10,bottom:this.pos.y2+10}},setCenter:function(a,b){if(a&&b){var c=(this.pos.x2+this.pos.x1)/2-a;this.pos.x1-=c,this.pos.x2-=c;var d=(this.pos.y2+this.pos.y1)/2-b;this.pos.y1-=d,this.pos.y2-=d}return this.pos.x="number"!=typeof a?(this.pos.x2+this.pos.x1)/2:a,this.pos.y="number"!=typeof b?(this.pos.y2+this.pos.y1)/2:b,this},setWidth:function(a){if(a){var b=(this.pos.x2-this.pos.x1)/2-a/2;this.pos.x1+=b,this.pos.x2-=b}return this.width="number"!=typeof a?this.pos.x2-this.pos.x1:a,this},setHeight:function(a){if(a){var b=(this.pos.y2-this.pos.y1)/2-a/2;this.pos.y1+=b,this.pos.y2-=b}return this.height="number"!=typeof a?this.pos.y2-this.pos.y1:a,this},setDimensions:function(a,b){return this.setWidth(a).setHeight(b),this},_render:function(){var b=this.stage?this.stage.ctx:a.stage.ctx;b&&(b.beginPath(),b.moveTo(this.pos.x1,this.pos.y1),b.lineTo(this.pos.x2,this.pos.y2),b.strokeStyle=this.color,b.lineWidth=this.thickness,b.lineCap=this.endStyle,b.stroke(),b.closePath())}}),a.Polygon=d.extend({initialize:function(b){if(arguments.length>2&&Array.isArray(arguments[2])){var c={};c.pos=new a.Vector(arguments[0],arguments[1]),c.vertices=arguments[2],"string"==typeof arguments[3]&&(c.color=arguments[3]),"number"==typeof arguments[4]&&(c.vel={x:arguments[4]}),"number"==typeof arguments[5]&&c.vel&&(c.vel.y=arguments[5]),-1!==Array.prototype.indexOf.call(arguments,!1)&&(c.addToStage=!1);var b=arguments[0]=c}this.shape="polygon";var d={vertices:[]};if(arguments[1]="object"==typeof arguments[1]?_.extend(arguments[1],d):d,this.relativeVertices=!0,(!b.pos||b.pos&&"number"!=typeof b.pos.x&&"number"!=typeof b.pos.y)&&(this.relativeVertices=!1),this._super&&this._super.apply(this,arguments),this.vertices.length<3)throw new Error("A line must have 3 or more vertices")},computeCentroid:function(b){var b=b?a.toVectors(b):a.toVectors(this.vertices),c=b.length,d=new a.Vector,e=0,f=0,g=0,h=0,i=0,j=0,k=0;for(k=0;c-1>k;++k)f=b[k].x,g=b[k].y,h=b[k+1].x,i=b[k+1].y,j=f*i-h*g,e+=j,d.x+=(f+h)*j,d.y+=(g+i)*j;return f=b[k].x,g=b[k].y,h=b[0].x,i=b[0].y,j=f*i-h*g,e+=j,d.x+=(f+h)*j,d.y+=(g+i)*j,e*=.5,d.x/=6*e,d.y/=6*e,d},bounds:function(a){if(!a){var b=[],c=[];if(this.pos&&void 0!==this.pos.x&&void 0!==this.pos.y)for(var d=0;d<this.vertices.length-1;d+=2)b.push(this.pos.x+this.vertices[d]),c.push(this.pos.y+this.vertices[d+1]);else for(var d=0;d<this.vertices.length-1;d+=2)b.push(this.vertices[d]),c.push(this.vertices[d+1]);return{left:Math.min.apply(Math,b),right:Math.max.apply(Math,b),top:Math.min.apply(Math,c),bottom:Math.max.apply(Math,c)}}if(!this.pos||!this.pos.x||!this.pos.y)return!1;var e=this.bounds(),f=this.pos.x-e.left,g=this.pos.y-e.top;"number"==typeof a.left&&(this.pos.x=a.left+f),"number"==typeof a.right&&(this.pos.x=a.right-f),"number"==typeof a.top&&(this.pos.y=a.top+g),"number"==typeof a.bottom&&(this.pos.y=a.bottom-g)},_render:function(b,c){var d=this.stage?this.stage.ctx:a.stage.ctx;if(d){if(this.fill?d.fillStyle=this.color:d.strokeStyle=this.strokeColor||this.color,d.beginPath(),this.pos&&this.relativeVertices)var b="number"==typeof b?b:this.pos.x,c="number"==typeof c?c:this.pos.y;else var b="number"==typeof b?b:0,c="number"==typeof c?c:0;d.moveTo(b+this.vertices[0],c+this.vertices[1]);for(var e=2;e<this.vertices.length;e+=2)d.lineTo(b+this.vertices[e],c+this.vertices[e+1]);d.lineTo(b+this.vertices[0],c+this.vertices[1]),this.thickness&&(d.lineWidth=this.thickness),this.fill?d.fill():d.stroke(),d.closePath()}}}),a.Sprite=a.Image.extend({initialize:function(a){this._super.apply(this,arguments),this.frames=[],a[b]&&(this.frames=a[b]);var b=this.frames;if(!a.frames){if(!a.stepSize)throw new Error("Not enough info. Must contain stepSize.");for(var c={x:"number"==typeof a.stepSize?a.stepSize:a.stepSize.x,y:"number"==typeof a.stepSize?a.stepSize:a.stepSize.y},d=a.width||c.x,e=a.height||c.y,f=a.pos||{x:0,y:0},g=a.columns||1,h=a.rows||1,i=a.framecount||g*h,j=0,k=0,l=0;h>l;l++){for(var m=0;g>m&&!(b.length>=i);m++)b.push({clip:{x:j,y:k,width:c.x,height:c.y},width:d,height:e,pos:f}),j+=c.x;j=0,k+=c.y}}for(var l=0;l<b.length;l++){var n=b[l];if(!n.clip)throw new Error("Frame must have a clip with x,y,width,height attributes",b,n);n.width||(n.width=this.width||n.clip.width),n.height||(n.height=this.height||n.clip.height)}this.setFrame(a.default||0),a.animations&&(this.animations={},this.addAnimations(a.animations))},addAnimations:function(a){for(var b in a){var c=a[b],d="string"==typeof c.name?c.name:b,e=this.animations[d]={};if(e.name=d,e.frames=[],c.range)if(c.range[1]>c.range[0])for(var f=c.range[0];f<=c.range[1];f++)e.frames.push(f);else for(var f=c.range[0];f>=c.range[1];f--)e.frames.push(f);else c.sequence&&(e.frames=c.sequence.slice(0));e.currentFrame=e.currentStep=0,e.speed=c.speed||1,e.repeat="undefined"!=typeof c.repeat?e.repeat:!0}},setAnimation:function(a){return this.animation===this.animations[a]?this:(this.animation=this.animations[a],this.animation.currentFrame=0,this)},removeAnimation:function(a){return this.animation?(this.setFrame("number"==typeof a?a:this.animation.frames[0]),this.animation=!1,this):this},setFrame:function(a){return"number"==typeof a&&this.frames[a]?(this.currentFrame=a,this.clip=this.frames[a].clip,this.width=this.frames[a].width,this.height=this.frames[a].height,this):!1},_render:function(){if(this.animation){var a=this.animation;a.currentStep>a.frames.length-1&&(a.currentStep=0),this.setFrame(a.frames[a.currentFrame]),a.currentStep+=a.speed,a.currentFrame=Math.round(a.currentStep)}this._super.apply(this,arguments)}}),a.Text=d.extend({initialize:function(a){if("object"!=typeof a){var b={};b.text=arguments[0],"number"==typeof arguments[1]&&(b.pos={x:arguments[1]}),"number"==typeof arguments[2]&&b.pos&&(b.pos.y=arguments[2]),"string"==typeof arguments[3]&&(b.size=arguments[3]),"string"==typeof arguments[4]&&(b.font=arguments[4]),"string"==typeof arguments[5]&&(b.weight=arguments[5]),arguments[6]&&(b.color=arguments[6]),"string"==typeof arguments[7]&&(b.align=arguments[7]),"string"==typeof arguments[8]&&(b.baseline=arguments[8]),-1!==Array.prototype.indexOf.call(arguments,!1)&&(b.addToStage=!1);var a=arguments[0]=b}this.shape="text";var c={text:"",size:"12px",font:"Helvetica",weight:"normal",pos:{x:0,y:0},rotation:0,color:"#000",collections:[],hidden:!1,events:!0};for(var d in c)this[d]=c[d];for(var d in arguments[0])this[d]="object"==typeof arguments[0][d]?_.clone(arguments[0][d]):arguments[0][d];arguments[0].addToStage!==!1&&this.add(),delete this.addToStage},bounds:function(){return{top:this.pos.y,left:this.pos.x,right:this.pos.x+10,bottom:this.pos.y+10}},_render:function(){var b=this.stage?this.stage.ctx:a.stage.ctx;b&&(b.fillStyle=this.color,b.font=this.weight+" "+this.size+" "+this.font,this.align&&(b.textAlign=this.align),this.baseline&&(b.textBaseline=this.baseline),b.fillText("function"==typeof this.text?this.text():this.text,this.pos.x,this.pos.y))}});var e=a.Physics={};a.Physics.intersecting=function(){function b(b,c,d){var e=c.x+((b.x-c.x)*Math.cos(d)-(b.y-c.y)*Math.sin(d)),f=c.y+((b.x-c.x)*Math.sin(d)+(b.y-c.y)*Math.cos(d));return new a.Vector(e,f)}return function(c,d,e){function f(b,c){var d,e,f,g,i={},j={};"circle"!==b.shape&&"rect"!==b.shape||"circle"!==c.shape&&"rect"!==c.shape?(i=b.bounds(),j=c.bounds()):(i=b.bounds(),j=c.bounds());var d=i.top<j.bottom&&i.top>j.top&&i.right>j.left&&i.left<j.right,f=i.left<j.right&&i.left>j.left&&i.bottom>j.top&&i.top<j.bottom,e=i.bottom>j.top&&i.bottom<j.bottom&&i.right>j.left&&i.left<j.right,g=i.right>j.left&&i.right<j.right&&i.bottom>j.top&&i.top<j.bottom;return d||e||f||g?"rect"===b.shape&&"rect"===c.shape&&l?h(b,c):new a.Vector:!1}function g(b,c){var d=b.pos.x,e=b.pos.y,f=c.pos.x,g=c.pos.y,h=b.radius,i=c.radius,j=Math.pow(f-d,2)+Math.pow(g-e,2),k=j<Math.pow(h+i,2);if(!k)return!1;var l=i+h-Math.sqrt(j),m=new a.Vector(f-d,g-e).normalize();return new a.Vector(m.x*(l+.01),m.y*(l+.01))}function h(b,c){for(var d=j(b),e=j(c),f=Number.MAX_VALUE,g=0;g<d.length;g++){var h=new a.Vector((d[g+1]?d[g+1].x:d[0].x)-d[g].x,(d[g+1]?d[g+1].y:d[0].y)-d[g].y),i=new a.Vector(-h.y,h.x).normalize(),l=k(i,d),m=k(i,e);if(l[0]>=m[1]||m[0]>=l[1])return!1;var n=-1*(m[1]-l[0]),o=Math.abs(n);f>o&&(f=o,mtv=new a.Vector(i.x*(n-.01),i.y*(n-.01)))}for(var g=0;g<e.length;g++){var h=new a.Vector((e[g+1]?e[g+1].x:e[0].x)-e[g].x,(e[g+1]?e[g+1].y:e[0].y)-e[g].y),i=new a.Vector(-h.y,h.x).normalize(),l=k(i,d),m=k(i,e);if(l[0]>=m[1]||m[0]>=l[1])return!1;var n=m[1]-l[0],o=Math.abs(n);f>o&&(f=o,mtv=new a.Vector(i.x*(n-.01),i.y*(n-.01)))}return"undefined"==typeof mtv&&console.log(b,c),mtv}function i(b,c){for(var d="circle"===b.shape?b:c,e="circle"===b.shape?c:b,f=j(e),g=Number.MAX_VALUE,h=d.pos.x,i=d.pos.y,l=f[0],m=Math.pow(d.pos.x-l.x,2)+Math.pow(d.pos.y-l.y,2),n=1;n<f.length;n++){var o=f[n],p=Math.pow(d.pos.x-o.x,2)+Math.pow(d.pos.y-o.y,2);m>p&&(m=p,l=f[n])}var q=new a.Vector(h-l.x,i-l.y).normalize(),r=k(q,f),s=k(q,d);if(r[0]>s[1]||s[0]>r[1])return!1;if(d===arguments[0])var t=s[1]-r[0];else var t=-1*(s[1]-r[0]);var u=Math.abs(t);g=u,mtv=new a.Vector(q.x*(d===b?t+.01:t-.01),q.y*(d===b?t+.01:t-.01));for(var n=0;n<f.length;n++){var v=new a.Vector((f[n+1]?f[n+1].x:f[0].x)-f[n].x,(f[n+1]?f[n+1].y:f[0].y)-f[n].y),q=new a.Vector(-v.y,v.x).normalize(),r=k(q,f),s=k(q,d);if(r[0]>s[1]||s[0]>r[1])return!1;if(d===arguments[0])var t=s[1]-r[0];else var t=-1*(s[1]-r[0]);var u=Math.abs(t);g>u&&(g=u,mtv=new a.Vector(q.x*(d===b?t+.01:t-.01),q.y*(d===b?t+.01:t-.01)))}return mtv}function j(c){var d=[];if("line"===c.shape){var f=new a.Vector(c.pos.x2-c.pos.x1,c.pos.y2-c.pos.y1),g=new a.Vector(-f.y,f.x).normalize(.01);d=[c.pos.x1,c.pos.y1,c.pos.x2,c.pos.y2,c.pos.x2+g.x,c.pos.y2+g.y,c.pos.x1+g.x,c.pos.y1+g.y]}else if("polygon"===c.shape){for(var h=0;h<c.vertices.length-1;h+=2)d.push((c.pos.x||0)+c.vertices[h],(c.pos.y||0)+c.vertices[h+1]);if(_.isArr(e)){for(var i=[],j=d,h=j.length-1;h>0;h-=2)i.push(j[h-1],j[h]);d=i}}else{if("rect"!==c.shape)return console.trace("Shape does not contain vertices");var k=c.width/2,l=c.height/2;d=[c.pos.x-k,c.pos.y-l,c.pos.x+k,c.pos.y-l,c.pos.x+k,c.pos.y+l,c.pos.x-k,c.pos.y+l]}for(var m=[],h=0;h<d.length;h+=2)m.push(new a.Vector(d[h],d[h+1]));if(0!==c.rotation)for(var h=0;h<m.length;h++)m[h]=b(m[h],c.pos,c.rotation);return m}function k(a,b){var c,d;if("circle"===b.shape){var e=b;d=a.dot(e.pos)-e.radius,c=d+2*e.radius}else{c=d=a.dot(b[0]);for(var f=0;f<b.length;f++){var g=a.dot(b[f]);d>g&&(d=g),g>c&&(c=g)}}return[d,c]}var l=!1;if(-1!==Array.prototype.indexOf.call(arguments,!0)&&(l=!0),d instanceof a.Vector&&(d=new a.Circle(d.x,d.y,.1,!1)),c instanceof a.Collection);else if(c instanceof Array){var m=!1;return _.each(c,function(b){if(b instanceof a.Shape){if(d instanceof a.Shape)var f=a.Physics.intersecting(b,d,e);else _.each(c,function(c){if(c instanceof a.Shape)var e=a.Physics.intersecting(b,c,d);return e&&(m=e),m?!1:void 0});return f&&(m=f),m?!1:void 0}}),m}if(c===d)return!1;var n=f(c,d);if(!n)return!1;if(l)return n;if("static"===d.shape){var o=d;d=c,c=o}return res="circle"===c.shape&&"circle"===d.shape?g(c,d):"circle"!==c.shape&&"circle"!==d.shape?h(c,d):"circle"===c.shape||"circle"===d.shape?i(c,d):!1}}();var f=e.SpatialHash=function(){return a.Class.extend({initialize:function(a){this.setCellSize(a),this.length=0,this.buckets={}},hash:function(a,b){return[Math.floor(a/this.cellWidth),Math.floor(b/this.cellHeight)]},insert:function(b){var c=this;if(b instanceof Array)_.each(b,function(a){c.insert(a)});else if(b instanceof a.Collection)b.each(function(a){c.insert(a)});else{if(!b||!b.bounds)throw console.log(this),new Error("The object to insert must have a bounds function that returns {top,left,bottom,right}");this.length++;for(var d=b.bounds(),e=this.hash(d.left,d.top),f=this.hash(d.right,d.bottom),g=e[0];g<=f[0];g++)for(var h=e[1];h<=f[1];h++){var i=g+":"+h;this.buckets[i]||(this.buckets[i]=[]),this.buckets[i].push(b)}}return this},retrieve:function(a){if(!a)return this.retrieveAll();for(var b=a.bounds(),c=this.hash(b.left,b.top),d=this.hash(b.right,b.bottom),e=[],f=c[0];f<d[0]+1;f++)for(var g=c[1];g<d[1]+1;g++){var h=f+":"+g;if(this.buckets[h])for(var i=0;i<this.buckets[h].length;i++)-1===e.indexOf(this.buckets[h][i])&&e.push(this.buckets[h][i])}return e},retrieveAll:function(){var a=[];return _.each(this.buckets,function(b){for(var c=0;c<b.length;c++)-1===a.indexOf(b[c])&&a.push(b[c])}),a},remove:function(a){if(a){for(var b=a.bounds(),c=this.hash(b.left,b.top),d=this.hash(b.right,b.bottom),e=c[0];e<d[0]+1;e++)for(var f=c[1];f<d[1]+1;f++){var g=e+":"+f,h=this.buckets[g]?this.buckets[g].indexOf(a):-1;this.buckets[g]&&-1!==h&&(this.buckets[g].splice(h,1),0===this.buckets[g].length&&delete this.buckets[g])}return this}},clear:function(){return this.length=0,this.buckets={},this},setCellSize:function(b,c){this.cellWidth=b||(a.isMobile?30:60),this.cellHeight=c||this.cellWidth;var d=this.retrieveAll();return this.clear().insert(d),this}})}();return e.World=function(){var b={},c={acc:{x:0,y:0},restitution:0,friction:0,mass:1};return a.Class.extend({initialize:function(b){b=b||{},this.setGravity(b.gravity),this.setCellSize(b.cellSize),this.collisions={dynamicdynamic:!0,dynamicstatic:!0,dynamickinematic:!0},this.config(b),this.shapes={"static":new a.Collection(!1,!0),kinematic:new a.Collection(!1,!0),dynamic:new a.Collection(!1,!0),all:new a.Collection(!1,!0)},this.shapes.static.name="Static Collision Shapes",this.shapes.kinematic.name="Kinematic Collision Shapes",this.shapes.dynamic.name="Dynamic Collision Shapes",this.shapes.all.name="All Collision Shapes"},setCellSize:function(b){!b&&a.cellSize&&(b=a.cellSize),this.staticHash=this.staticHash instanceof f?this.staticHash.setCellSize(b):new f(b),this.kinematicHash=this.kinematicHash instanceof f?this.kinematicHash.setCellSize(b):new f(b),this.dynamicHash=this.dynamicHash instanceof f?this.dynamicHash.setCellSize(b):new f(b)},setGravity:function(b){var c="undefined"!=typeof b?"number"==typeof b.x?b.x:"number"==typeof arguments[0]?arguments[0]:0:"undefined"!=typeof a.gravity?a.gravity.x:0,d="undefined"!=typeof b?"number"==typeof b.y?b.y:"number"==typeof arguments[1]?arguments[1]:0:"undefined"!=typeof a.gravity?a.gravity.y:0;
this.gravity=new a.Vector(c,d)},config:function(a){var b=this;return"object"!=typeof a?!1:("undefined"!=typeof a.gravity&&this.setGravity(a.gravity),"undefined"!=typeof a.collisions&&(a.collisions?"object"==typeof a.collisions&&_.each(a.collisions,function(a,c){a===!1&&(b.collisions[c]=!1)}):this.collisions=!1),this.onlyAABB="boolean"==typeof a.onlyAABB?a.onlyAABB:!1,this.framerateVel="boolean"==typeof a.framerateVel?a.framerateVel:!0,void 0)},add:function(d){if(d instanceof a.Text)return d.type="static",void 0;if(d instanceof a.Collection)d.each(function(a){self.add(a)});else if(!(d instanceof a.Shape)||d instanceof a.Shape&&d.physics===!1)return!1;return d.type||(d.type="line"===d.shape?"static":"dynamic"),d.on("collision",function(){d.colliding=!0}),this.shapes.all.add(d),"static"===d.type&&(this.shapes.static.add(d),this.staticHash.insert(d)),"kinematic"===d.type&&(this.shapes.kinematic.add(d),this.kinematicHash.insert(d)),"dynamic"===d.type&&(this.shapes.dynamic.add(d),this.dynamicHash.insert(d)),_.each(c,function(a,b){d[b]="undefined"==typeof d[b]?a:d[b]}),_.each(b,function(a,b){d[b]=d[b]||a}),this},remove:function(c){return c instanceof a.Shape?this.shapes.all.has(c)?(this.shapes.all.remove(c),"static"===c.type?(this.shapes.static.remove(c),this.staticHash.remove(c)):"kinematic"===c.type?(this.shapes.kinematic.remove(c),this.kinematicHash.remove(c)):"dynamic"===c.type&&(this.shapes.dynamic.remove(c),this.dynamicHash.remove(c)),_.each(c,function(a,d){d in b&&delete c[d]}),this):!1:!1},update:function(){var b=this;this.enableHash!==!1&&(this.collisions.dynamicstatic!==!1&&b.staticHash.length!==b.shapes.static.length()&&b.staticHash.clear().insert(b.shapes.static),this.collisions.dynamickinematic!==!1&&b.kinematicHash.clear().insert(b.shapes.kinematic),(this.collisions.dynamicdynamic!==!1||this.collisions.dynamicstatic!==!1)&&b.dynamicHash.clear().insert(b.shapes.dynamic)),b.collisions.dynamicstatic&&b.collisions!==!1&&b.shapes.dynamic.length()>=b.shapes.static.length()&&b.shapes.static.each(function(a){a.colliding=!1,a.enableCollisions!==!1&&a.physics!==!1&&(this.enableHash!==!1?_.each(b.dynamicHash.retrieve(a),function(c){c.physics!==!1&&c.enableCollisions!==!1&&b.handleCollisions(a,c)}):_.each(b.shapes.dynamic,function(c){c.physics!==!1&&c.enableCollisions!==!1&&b.handleCollisions(a,c)}))}),b.shapes.kinematic.each(function(c){return"kinematic"!==c.type?(b.shapes.kinematic.remove(c),"static"===c.type?b.shapes.static.add(c):b.shapes.dynamic.add(c),void 0):(c.physics!==!1&&c.one("update",function(){c.pos instanceof a.Vector&&c.vel instanceof a.Vector||(c.pos=new a.Vector(c.pos?c.pos.x:0,c.pos?c.pos.y:0),c.vel=new a.Vector(c.vel?c.vel.x:0,c.vel?c.vel.y:0)),b.collisions!==!1&&c.enableCollisions!==!1&&b.collisions.dynamickinematic&&b.shapes.dynamic.length()>=b.shapes.kinematic.length()&&(c.colliding=!1,this.enableHash!==!1?_.each(b.dynamicHash.retrieve(c),function(a){a.physics!==!1&&a.enableCollisions!==!1&&b.handleCollisions(c,a)}):_.each(b.shapes.dynamic,function(a){a.physics!==!1&&a.enableCollisions!==!1&&b.handleCollisions(c,a)})),c.pos.add(c.vel.multiply(c.stage&&c.framerateVel!==!1&&b.framerateVel!==!1?c.stage.deltaFramerate:1))}),void 0)}),b.shapes.dynamic.each(function(c){return"dynamic"!==c.type?(b.shapes.dynamic.remove(c),"static"===c.type?b.shapes.static.add(c):b.shapes.kinematic.add(c),void 0):(c.physics!==!1&&c.one("update",function(){function d(a){a.physics!==!1&&a.enableCollisions!==!1&&b.handleCollisions(c,a)}c.pos instanceof a.Vector&&c.vel instanceof a.Vector&&c.acc instanceof a.Vector||(c.pos=new a.Vector(c.pos?c.pos.x:0,c.pos?c.pos.y:0),c.vel=new a.Vector(c.vel?c.vel.x:0,c.vel?c.vel.y:0),c.acc=new a.Vector(c.acc?c.acc.x:0,c.acc?c.acc.y:0)),b.collisions!==!1&&c.enableCollisions!==!1&&(c.colliding=!1,b.collisions.dynamicstatic&&b.shapes.dynamic.length()<b.shapes.static.length()&&(this.enableHash!==!1?_.each(b.staticHash.retrieve(c),d):_.each(b.shapes.static,d)),b.collisions.dynamickinematic&&b.shapes.dynamic.length()<b.shapes.kinematic.length()&&(this.enableHash!==!1?_.each(b.kinematicHash.retrieve(c),d):_.each(b.shapes.kinematic,d)),b.collisions.dynamicdynamic&&(this.enableHash!==!1?_.each(b.dynamicHash.retrieve(c),d):_.each(b.shapes.dynamic,d))),c.stage&&c.stage.world&&(c.gravity!==!1&&c.colliding!==!0?c.acc=c.stage.world.gravity:c.colliding&&(c.acc=new a.Vector)),c.vel.add(c.acc),c.pos.add(c.vel.multiply(c.stage&&c.framerateVel!==!1&&b.framerateVel!==!1?c.stage.deltaFramerate:1))}),void 0)})},handleCollisions:function(b,c){if(!b||!c||b===c||"dynamic"!==b.type&&"dynamic"!==c.type)return!1;if("dynamic"!==c.type){var d=c;c=b,b=d}if(b.events)var e=b.trigger("collisionCheck",[c]);if(c.events)var f=c.trigger("collisionCheck",[b]);if(e instanceof Array&&-1!==e.indexOf(!1)||f instanceof Array&&-1!==f.indexOf(!1))return!0;var g=a.Physics.intersecting(b,c,this.onlyAABB);if(!g)return!1;if("dynamic"!==b.type){if(b.events)var e=b.trigger("collision",[c,g]);if(c.events)var f=c.trigger("collision",[b,g])}else{if(b.events)var e=b.trigger("collision",[c,g.divide(2).multiply(-1)]);if(c.events)var f=c.trigger("collision",[b,g.divide(2)])}if(e instanceof Array&&-1!==e.indexOf(!1)||f instanceof Array&&-1!==f.indexOf(!1))return!0;if(e instanceof Array&&-1!==e.indexOf(!1)||f instanceof Array&&-1!==f.indexOf(!1))return!0;var h=b.restitution&&c.restitution?1*b.restitution*c.restitution:Math.max(b.restitution,c.restitution),i=(b.friction+c.friction)/2;if("dynamic"!==b.type){if(c.vel.y>0&&g.y>0||c.vel.y<0&&g.y<0)return;c.pos.add(g),0===c.rotation&&0===b.rotation&&(0!==c.vel.x&&Math.abs(g.x)>0&&(c.vel.x*=-1*h),0!==c.vel.y&&Math.abs(g.y)>0&&(c.vel.y*=-1*h),c.vel.x<0&&i?(c.vel.x*=1-i/10,c.vel.x>-.01&&(c.vel.x=0)):c.vel.x>0&&i&&(c.vel.x*=1-i/10,c.vel.x<.01&&(c.vel.x=0)))}else if(c.pos.add(g.divide(2)),b.pos.subtract(g.divide(2)),("circle"===c.shape||"rect"===c.shape)&&0===c.rotation){if(0!==c.vel.x&&0!==g.x){var d=b.vel.x;b.vel.x=c.vel.x,c.vel.x=d,c.vel.x*=1*h,b.vel.x*=1*h}if(0!==c.vel.y&&0!==g.y){var d=b.vel.y;b.vel.y=c.vel.y,c.vel.y=d,c.vel.y*=1*h,b.vel.y*=1*h}c.vel.x<0&&i?(c.vel.x*=1-i/10,c.vel.x>-.001&&(c.vel.x=0)):c.vel.x>0&&i&&(c.vel.x*=1-i/10,c.vel.x<.001&&(c.vel.x=0)),b.vel.x<0&&i?(b.vel.x*=1-i/10,b.vel.x>-.001&&(b.vel.x=0)):b.vel.x>0&&i&&(b.vel.x*=1-i/10,b.vel.x<.001&&(b.vel.x=0))}if(b.events)var e=b.trigger("collisionResolved",[c,g]);if(c.events)var f=c.trigger("collisionResolved",[b,g])}})}(),a.toDegrees=function(a){return a*(180/Math.PI)},a.toRadians=function(a){return a*(Math.PI/180)},a.rgb=function(a,b,c){if(_.isArr(a)){var d=a;a=d[0],b=d[1],c=d[2]}return"rgb("+a+","+b+","+c+")"},a.random=function(a,b){var b="number"==typeof b?b:0,a="number"==typeof a?a:1;return Math.round(b+Math.random()*(a-b))},a.random.float=function(a,b){var b="number"==typeof b?b:0,a="number"==typeof a?a:1;return b+Math.random()*(a-b)},a.random.color=function(){return"rgb("+a.random(255)+","+a.random(255)+","+a.random(255)+")"},a.random.choice=function(b){return Array.isArray(b)?b[a.random(b.length-1)]:arguments[a.random(arguments.length-1)]},a.Vector=function(a,b){this.x="number"==typeof a?a:0,this.y="number"==typeof b?b:0},a.Vector.prototype.dot=function(a){return this.x*a.x+this.y*a.y},a.Vector.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},a.Vector.prototype.normalize=function(a){var b=(a||1)/this.length();return this.x*=b,this.y*=b,this},a.Vector.prototype.add=function(b,c){if(!c&&b instanceof a.Vector){var d=b;b=d.x,c=d.y}return b&&(this.x+=b),c&&(this.y+=c),this},a.Vector.prototype.plus=function(){return this.add.apply(new a.Vector(this.x,this.y),arguments)},a.Vector.prototype.subtract=function(b,c){if(!c&&b instanceof a.Vector){var d=b;b=d.x,c=d.y}return b&&(this.x-=b),c&&(this.y-=c),this},a.Vector.prototype.minus=function(){return this.subtract.apply(new a.Vector(this.x,this.y),arguments)},a.Vector.prototype.multiply=function(b,c){return c?new a.Vector(this.x*b,this.y*c):new a.Vector(this.x*b,this.y*b)},a.Vector.prototype.divide=function(b,c){return c?new a.Vector(this.x/b,this.y/c):new a.Vector(this.x/b,this.y/b)},a.Vector.prototype.ceil=function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},a.Vector.prototype.floor=function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},a.Vector.prototype.round=function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},a.Vector.prototype.set=function(b,c){if(!c&&b instanceof a.Vector){var d=b;b=d.x,c=d.y}return"number"==typeof b&&(this.x=b),"number"==typeof c&&(this.y=c),this},a.toVectors=function(b){if(b[0]&&b[0]instanceof a.Vector)return b;b=b.map(function(b,c,d){return c%2===0?new a.Vector(b,d[c+1]):void 0});for(var c=b.length;c>0;c--)"undefined"==typeof b[c]&&b.splice(c,1);return b},Emit.mixin(a),Emit.mixin(a.Class),a.events=!0,a.stages=[],a.collections=[],a.isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),a.touchEnabled="ontouchstart"in window,a.event=new b,a});